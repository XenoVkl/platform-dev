<?php

/**
 * @file
 * Module file of the TMGMT DGT connector.
 */

use EC\Poetry\Messages\Notifications\TranslationReceived;
use Drupal\tmgmt_dgt_connector\Subscriber;

define('TMGMT_DGT_CONNECTOR_MAX_SMALLJOB_LENGTH', 300);
define('TMGMT_DGT_CONNECTOR_TRANSLATOR_NAME', 'tmgmt_dgt_connector');

module_load_include('inc', 'tmgmt_dgt_connector');

/**
 * Implements hook_nexteuropa_poetry_notification_translation_received().
 */
function tmgmt_dgt_connector_nexteuropa_poetry_notification_translation_received(TranslationReceived $message) {

  $subscriber = new Subscriber();
  $subscriber->onTranslationReceivedEvent($message);
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Change the form on the 'Translate' tab to provide the
 * nexteuropa_dgt_connector module functionalities.
 */
function tmgmt_dgt_connector_form_tmgmt_entity_ui_translate_form_alter(&$form, &$form_state) {

  $entity = $form_state['entity'];
  $length = _tmgmt_dgt_connector_get_content_length($entity);

  if ($length > TMGMT_DGT_CONNECTOR_MAX_SMALLJOB_LENGTH) {
    // Remove add to cart button.
    unset($form['top_actions']);
  }

  // Set plugin for #cart .
  if (isset($form_state['tmgmt_cart'])) {
    $form_state['tmgmt_cart']['plugin'] = 'workbench_moderation';
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function tmgmt_dgt_connector_form_tmgmt_ui_cart_content_alter(&$form, &$form_state) {
  // Add a callback function when submiting.
  $callback = '_tmgmt_dgt_connector_workbench_store_request_languages_callback';
  $form['request_translation']['#submit'] = [$callback];
}

/**
 * Implements hook_entity_info_alter().
 */
function tmgmt_dgt_connector_entity_info_alter(&$entity_info) {
  $entity_info['tmgmt_job']['controller class'] = 'TMGMTPoetryJobController';
  $entity_info['tmgmt_job']['entity class'] = 'TMGMTPoetryJob';
  $entity_info['tmgmt_translator']['access callback'] = '_tmgmt_dgt_connector_translator_access';
}

/**
 * Implements hook_tmgmt_translator_plugin_info().
 */
function tmgmt_dgt_connector_tmgmt_translator_plugin_info() {
  return array(
    'tmgmt_dgt_connector' => array(
      'label' => t('TMGMT DGT Connector'),
      'description' => t('TMGMT DGT Connector Translation service.'),
      'plugin controller class' => 'TmgmtDgtConnectorTranslatorPluginController',
      'ui controller class' => 'TmgmtDgtConnectorTranslatorUIController',
    ),
  );
}
